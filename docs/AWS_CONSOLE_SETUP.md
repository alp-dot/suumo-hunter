# AWS Console セットアップガイド

このガイドでは、Terraformを使わずに**AWS Management Console（ブラウザ）** から直接 SUUMO Hunter をセットアップする方法を説明します。

AWS初学者の方でも、画面の指示に従って設定できるように詳しく解説しています。

## 目次

1. [前提条件](#前提条件)
2. [全体の流れ](#全体の流れ)
3. [Step 1: S3バケットの作成](#step-1-s3バケットの作成)
4. [Step 2: IAMロールの作成](#step-2-iamロールの作成)
5. [Step 3: Lambda関数の作成](#step-3-lambda関数の作成)
6. [Step 4: EventBridgeスケジュールの設定](#step-4-eventbridgeスケジュールの設定)
7. [Step 5: 動作確認](#step-5-動作確認)
8. [トラブルシューティング](#トラブルシューティング)
9. [リソースの削除](#リソースの削除)

---

## 前提条件

### 必要なもの

- **AWSアカウント** - [AWS公式サイト](https://aws.amazon.com/jp/)で作成可能
- **Discord Webhook URL** - 通知先のDiscordチャンネル用
- **SUUMO検索URL** - 監視したい物件の検索条件URL
- **Lambda用ZIPファイル** - ビルド済みの `lambda.zip`

### Lambda用ZIPファイルの準備

ローカル環境でビルドするか、GitHub Releasesからダウンロードしてください。

```bash
# ローカルでビルドする場合
git clone https://github.com/alp-dot/suumo-hunter.git
cd suumo-hunter
make package
# build/lambda.zip が生成されます
```

### 使用するAWSリージョン

このガイドでは **東京リージョン（ap-northeast-1）** を使用します。

---

## 全体の流れ

```
┌─────────────────────────────────────────────────────────┐
│  1. S3バケット作成（物件データ保存用）                    　　│
│         ↓                                               │
│  2. IAMロール作成（Lambda用の権限設定）                  　  │
│         ↓                                               │
│  3. Lambda関数作成（メイン処理）                      　    │
│         ↓                                               │
│  4. EventBridge設定（定期実行スケジュール）            　    │
│         ↓                                               │
│  5. 動作確認                                             │
└─────────────────────────────────────────────────────────┘
```

---

## Step 1: S3バケットの作成

S3バケットは物件データ（CSV）を保存するために使用します。

### 1.1 S3コンソールを開く

1. [AWS Management Console](https://console.aws.amazon.com/) にログイン
2. 検索バーに「**S3**」と入力してS3コンソールを開く

### 1.2 バケットを作成

1. **「バケットを作成」** ボタンをクリック

2. **一般的な設定**
   - **バケット名**: `suumo-hunter-nakano-properties-{あなたのAWSアカウントID}`
     - 例: `suumo-hunter-nakano-properties-123456789012`
     - ⚠️ バケット名はグローバルで一意である必要があります
   - **AWSリージョン**: `アジアパシフィック（東京）ap-northeast-1`

3. **オブジェクト所有者**
   - 「ACL無効」のまま（デフォルト）

4. **このバケットのブロックパブリックアクセス設定**
   - すべてのチェックが入った状態のまま（デフォルト）
   - ⚠️ パブリックアクセスはブロックしたままにしてください

5. **バケットのバージョニング**
   - **「有効にする」を選択**（推奨）
   - バージョニングを有効にすると、誤って削除しても復元できます

6. **タグ（オプション）**
   - 「タグを追加」をクリック
   - キー: `Project`、値: `suumo-hunter`
   - キー: `Instance`、値: `nakano`

7. **「バケットを作成」** をクリック

✅ バケットが作成されたことを確認してください。

---

## Step 2: IAMロールの作成

Lambda関数がS3やCloudWatch Logsにアクセスするための権限を設定します。

### 2.1 IAMコンソールを開く

1. 検索バーに「**IAM**」と入力してIAMコンソールを開く
2. 左側メニューから **「ロール」** をクリック

### 2.2 ロールを作成

1. **「ロールを作成」** ボタンをクリック

2. **信頼されたエンティティを選択**
   - 信頼されたエンティティタイプ: **「AWSのサービス」**
   - ユースケース: **「Lambda」** を選択
   - **「次へ」** をクリック

3. **許可を追加**
   - 検索バーに `AWSLambdaBasicExecutionRole` と入力
   - **AWSLambdaBasicExecutionRole** にチェックを入れる
   - **「次へ」** をクリック

4. **名前、確認、および作成**
   - **ロール名**: `suumo-hunter-lambda-role`
   - **説明**: `IAM role for SUUMO Hunter Lambda function`
   - タグを追加（オプション）:
     - キー: `Project`、値: `suumo-hunter`
   - **「ロールを作成」** をクリック

### 2.3 S3アクセス権限を追加

1. 作成したロール **「suumo-hunter-lambda-role」** をクリックして開く

2. **「許可を追加」** → **「インラインポリシーを作成」** をクリック

3. **ポリシーエディタ** で **「JSON」** タブを選択

4. 以下のJSONを貼り付け（バケット名は実際のものに置き換えてください）:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "S3Access",
            "Effect": "Allow",
            "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:DeleteObject"
            ],
            "Resource": "arn:aws:s3:::suumo-hunter-nakano-properties-*/*"
        },
        {
            "Sid": "S3ListBucket",
            "Effect": "Allow",
            "Action": "s3:ListBucket",
            "Resource": "arn:aws:s3:::suumo-hunter-nakano-properties-*"
        }
    ]
}
```

5. **「次へ」** をクリック

6. **ポリシー名**: `suumo-hunter-s3-access`

7. **「ポリシーの作成」** をクリック

✅ ロールに2つのポリシーが付与されていることを確認してください。

---

## Step 3: Lambda関数の作成

### 3.1 Lambdaコンソールを開く

1. 検索バーに「**Lambda**」と入力してLambdaコンソールを開く
2. リージョンが **「東京」** になっていることを確認

### 3.2 関数を作成

1. **「関数の作成」** ボタンをクリック

2. **基本的な情報**
   - 作成方法: **「一から作成」**
   - **関数名**: `suumo-hunter-nakano`
   - **ランタイム**: `Amazon Linux 2023` を選択
   - **アーキテクチャ**: **`arm64`** を選択（重要！）

3. **デフォルトの実行ロールの変更** を展開
   - **「既存のロールを使用する」** を選択
   - **既存のロール**: `suumo-hunter-lambda-role` を選択

4. **「関数の作成」** をクリック

### 3.3 コードをアップロード

1. 関数が作成されたら、**「コード」** タブを確認

2. **「アップロード元」** → **「.zipファイル」** をクリック

3. 準備した `lambda.zip` をアップロード

4. **「保存」** をクリック

### 3.4 ランタイム設定を変更

1. **「コード」** タブの下部にある **「ランタイム設定」** セクションを確認

2. **「編集」** をクリック

3. **ハンドラ**: `bootstrap` と入力（デフォルトから変更）

4. **「保存」** をクリック

### 3.5 環境変数を設定

1. **「設定」** タブをクリック

2. 左側メニューから **「環境変数」** をクリック

3. **「編集」** をクリック

4. **「環境変数の追加」** を4回クリックして、以下を設定:

| キー | 値 | 説明 |
|-----|-----|------|
| `SUUMO_URL` | `https://suumo.jp/jj/chintai/ichiran/...` | SUUMOの検索URL |
| `DISCORD_WEBHOOK_URL` | `https://discord.com/api/webhooks/...` | Discord Webhook URL |
| `S3_BUCKET` | `suumo-hunter-nakano-properties-123456789012` | 作成したS3バケット名 |
| `S3_KEY` | `properties.csv` | 保存するファイル名 |

5. （オプション）追加の環境変数:

| キー | 値 | 説明 |
|-----|-----|------|
| `MAX_PAGE` | `30` | スクレイピング最大ページ数 |

6. **「保存」** をクリック

### 3.6 タイムアウトとメモリを設定

1. **「設定」** タブ → **「一般設定」** をクリック

2. **「編集」** をクリック

3. 設定を変更:
   - **メモリ**: `256` MB
   - **タイムアウト**: `5` 分 `0` 秒

4. **「保存」** をクリック

✅ Lambda関数の設定が完了しました。

---

## Step 4: EventBridgeスケジュールの設定

Lambda関数を定期的に自動実行するためのスケジュールを設定します。

### 4.1 EventBridge Schedulerを開く

1. 検索バーに「**EventBridge**」と入力
2. EventBridgeコンソールで左側メニューから **「スケジュール」** をクリック

### 4.2 スケジュールを作成

1. **「スケジュールを作成」** をクリック

2. **スケジュール名とスケジュールパターン**
   - **スケジュール名**: `suumo-hunter-nakano-schedule`
   - **説明**: `SUUMO Hunter scheduled execution`
   - **スケジュールグループ**: `default`

3. **スケジュールパターン**
   - **発生**: **「定期的なスケジュール」**
   - **スケジュールの種類**: **「cronベースのスケジュール」**
   - **cronの式**: `15 0,6,9,13 * * ? *`
     - これはUTC時間で、日本時間では 09:15, 15:15, 18:15, 22:15 に実行されます
   - **フレックスタイムウィンドウ**: `オフ`

4. **タイムゾーン**
   - タイムゾーン: `Asia/Tokyo` を選択するか、UTCのままで上記cron式を使用

5. **「次へ」** をクリック

### 4.3 ターゲットを選択

1. **ターゲットの詳細**
   - **ターゲットAPI**: **「AWS Lambda Invoke」**

2. **Lambda関数**
   - **関数**: `suumo-hunter-nakano` を選択

3. **「次へ」** をクリック

### 4.4 設定

1. **スケジュールの状態**: **「有効」**

2. **再試行ポリシー**
   - 最大再試行回数: `2`
   - イベントの最大経過時間: `1` 時間

3. **暗号化**: デフォルトのまま

4. **アクセス許可**
   - **実行ロール**: **「このスケジュールの新しいロールを作成」**
   - または既存のロールを使用

5. **「次へ」** をクリック

### 4.5 確認と作成

1. 設定内容を確認
2. **「スケジュールを作成」** をクリック

✅ スケジュールが作成されました。

---

## Step 5: 動作確認

### 5.1 手動でテスト実行

1. **Lambda コンソール** → `suumo-hunter-nakano` を開く

2. **「テスト」** タブをクリック

3. **テストイベントを作成**
   - イベント名: `TestEvent`
   - イベントJSON:
   ```json
   {}
   ```
   - **「保存」** をクリック

4. **「テスト」** ボタンをクリック

5. **実行結果** を確認
   - ステータスが「成功」になれば正常です
   - Discordに通知が届いているか確認してください

### 5.2 ログを確認

1. **「モニタリング」** タブをクリック

2. **「CloudWatch Logsを表示」** をクリック

3. 最新のログストリームをクリックして詳細を確認

### 5.3 S3にデータが保存されているか確認

1. **S3コンソール** → 作成したバケットを開く
2. `properties.csv` ファイルが作成されていることを確認

---

## トラブルシューティング

### エラー: "Runtime.InvalidEntrypoint"

**原因**: ハンドラの設定が間違っている

**解決方法**:
1. Lambda → 設定 → ランタイム設定
2. ハンドラを `bootstrap` に変更

### エラー: "AccessDenied" (S3)

**原因**: IAMロールにS3へのアクセス権限がない

**解決方法**:
1. IAMロールに付与したインラインポリシーを確認
2. バケット名が正しいか確認

### エラー: "Task timed out"

**原因**: 処理時間がタイムアウト設定を超えた

**解決方法**:
1. Lambda → 設定 → 一般設定
2. タイムアウトを `5分` 以上に設定

### Discordに通知が来ない

**原因**: Webhook URLが間違っている

**解決方法**:
1. 環境変数 `DISCORD_WEBHOOK_URL` を確認
2. Discordで新しいWebhookを作成して再設定

### スケジュールが動作しない

**原因**: EventBridgeの設定が無効になっている

**解決方法**:
1. EventBridge → スケジュール → 該当スケジュールを確認
2. 状態が「有効」になっているか確認

---

## リソースの削除

不要になった場合は、以下の順序でリソースを削除してください。

### 削除順序（重要）

1. **EventBridge スケジュール** を削除
2. **Lambda 関数** を削除
3. **S3 バケット** を空にしてから削除
4. **IAM ロール** を削除（他で使用していない場合）

### S3バケットを空にする方法

1. S3コンソールでバケットを開く
2. すべてのオブジェクトを選択
3. **「削除」** をクリック
4. バージョニングが有効な場合は「バージョンを表示」をオンにして古いバージョンも削除
5. バケットが空になったら **「バケットを削除」**

---

## 複数エリアの追加

別のエリア（例: 渋谷）を追加する場合は、Step 1〜4を繰り返します。

ただし、以下の点に注意:
- **S3バケット**: 新しいバケットを作成（例: `suumo-hunter-shibuya-properties-...`）
- **IAMロール**: 既存の `suumo-hunter-lambda-role` を再利用可能
  - S3ポリシーに新しいバケットを追加
- **Lambda関数**: 新しい関数を作成（例: `suumo-hunter-shibuya`）
- **EventBridge**: 新しいスケジュールを作成

---

## 参考リンク

- [AWS Lambda 入門](https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/getting-started.html)
- [Amazon S3 入門](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/GetStartedWithS3.html)
- [Amazon EventBridge Scheduler](https://docs.aws.amazon.com/ja_jp/eventbridge/latest/userguide/scheduler.html)
- [IAM ロールの作成](https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/id_roles_create.html)

---

## 次のステップ

- [Terraformでの管理](../terraform/README.md) - Infrastructure as Codeでより効率的に管理
- [アーキテクチャ詳細](アーキテクチャ設計書.md) - システム構成の理解
- [分析機能](分析機能設計書.md) - 割安度判定の仕組み
